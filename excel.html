<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Five Magics Designs Manager | ORIGINAL FIXED</title>
    <!-- Favicon emoji relacionado a finanzas -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='60' font-size='70'>üí∏</text></svg>">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuente moderna para n√∫meros -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet">
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-1H3XPM82ED"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-1H3XPM82ED');
    </script>
    <style>
        /* ESTILOS ORIGINALES TEMA DARK METAL */
        :root {
            --bg-color: #0d0d0f;
            --card-bg: #1a1a1d;
            --text-main: #ffffff;
            --text-muted: #a0a0a0;
            --accent-violet: #b791ff;
            --accent-cyan: #01eeff;
            --success: #6fb167;
            --danger: #fc3939;
            --border-radius: 8px;
            --border-color: #2a2a3f;
            --font-main: 'Segoe UI', sans-serif;
            --font-mono: monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: var(--font-main);
            font-size: 14px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* HEADER */
        header {
            background: linear-gradient(135deg, #111 0%, #222 100%);
            padding: 15px 20px;
            border-bottom: 2px solid var(--accent-violet);
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
            flex-shrink: 0;
        }

        h1 { color: var(--accent-violet); text-transform: uppercase; font-size: 1.4em; font-weight: 800; margin: 0; letter-spacing: 1px; }
        h1 span { color: white; font-size: 0.6em; }

        /* INPUTS & BUTTONS */
        input, select, textarea {
            background-color: #2a2a2e;
            border: 1px solid #444;
            color: #fff;
            padding: 8px 10px;
            border-radius: 4px;
            font-family: inherit;
            width: 100%; /* FIX: Para que no se salgan del modal */
        }
        input:focus, select:focus { border-color: var(--accent-cyan); }

        .btn {
            cursor: pointer; padding: 8px 14px; border: none; border-radius: 4px; font-weight: 600;
            text-transform: uppercase; font-size: 11px; display: inline-flex; align-items: center; gap: 5px;
        }
        .btn-primary { background: linear-gradient(45deg, var(--accent-violet), #6a5acd); color: white; }
        .btn-secondary { background-color: #333; color: white; border: 1px solid #444; }
        .btn-danger { background-color: rgba(217, 118, 118, 0.1); color: var(--danger); border: 1px solid var(--danger); }
        .btn-sm { padding: 5px 10px; font-size: 10px; }

        /* CONTROLS */
        .controls-bar {
            padding: 10px 20px; background-color: #151518; border-bottom: 1px solid var(--border-color);
            display: flex; gap: 10px; align-items: center; flex-shrink: 0;
        }
        .filters-group { display: flex; gap: 10px; margin-left: auto; align-items: center; }

        /* STATS */
        .stats-container {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;
            padding: 10px 20px; background: #111; border-bottom: 1px solid #333; flex-shrink: 0;
        }
        .stat-card { background: #1a1a1d; padding: 8px; border-radius: 4px; border: 1px solid #333; text-align: center; }
        .stat-val {
            font-size: 16px;
            font-weight: bold;
            color: var(--accent-cyan);
            font-family: 'Montserrat', 'Segoe UI', Arial, sans-serif;
            letter-spacing: 0.5px;
        }
        .stat-lbl { font-size: 10px; text-transform: uppercase; color: #888; }

        /* TABLE */
        .table-container { flex: 1; overflow: auto; padding: 0 0 20px 0; position: relative; }
        table { width: 100%; border-collapse: collapse; min-width: 1400px; }
        thead th {
            position: sticky; top: 0; background-color: #111; color: var(--accent-violet);
            padding: 10px; text-align: left; font-size: 11px; text-transform: uppercase;
            border-bottom: 2px solid #333; z-index: 10; cursor: pointer; user-select: none;
        }
        tbody td { padding: 8px 10px; border-bottom: 1px solid #222; vertical-align: middle; color: #ccc; }
        tr:hover { background-color: #1f1f22; }
        .row-entregado { background-color: #23232a !important; opacity: 0.7; }
        .money {
            font-family: 'Montserrat', 'Segoe UI', Arial, sans-serif;
            letter-spacing: 0.5px;
            font-variant-numeric: lining-nums proportional-nums;
        }

        .order-id {
            font-family: 'Montserrat', 'Segoe UI', Arial, sans-serif;
            color: var(--accent-violet);
            background: #222;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 16px;
            font-weight: bold;
            letter-spacing: 1px;
            display: inline-block;
            margin: 0 0 2px 0;
        }
        .pos { color: var(--success); } .neg { color: var(--danger); }
        .tracking-cell {
            font-family: 'Montserrat', 'Segoe UI', Arial, sans-serif;
            background: #222;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 15px;
            color: var(--accent-cyan);
            letter-spacing: 0.5px;
            font-variant-numeric: lining-nums proportional-nums;
        }

        /* MODAL (ARREGLADO) */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(3px);
            display: none; justify-content: center; align-items: flex-start;
            z-index: 2000; overflow-y: auto; padding: 20px;
        }
        .modal-overlay.open { display: flex; }
        
        .modal-content {
            background-color: var(--card-bg); width: 100%; max-width: 850px;
            border-radius: 8px; border: 1px solid var(--accent-violet);
            margin-top: 20px; margin-bottom: 50px; box-shadow: 0 0 30px rgba(0,0,0,0.5);
            display: flex; flex-direction: column;
        }

        .modal-header {
            padding: 15px 20px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center;
            background: #151518; border-radius: 8px 8px 0 0;
        }
        .modal-body { padding: 20px; }

        /* GRID FORMULARIO */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* 2 columnas */
            gap: 15px;
        }
        @media (max-width: 768px) { .form-grid { grid-template-columns: 1fr; } } /* 1 columna en m√≥vil */

        .form-section {
            grid-column: 1 / -1; margin-top: 15px; margin-bottom: 5px;
            color: var(--accent-cyan); border-bottom: 1px solid #333; padding-bottom: 5px;
            font-weight: bold; font-size: 12px; letter-spacing: 1px;
        }
        .full-span { grid-column: 1 / -1; }
        
        .form-group { display: flex; flex-direction: column; gap: 4px; }
        .form-group label { font-size: 11px; color: #888; text-transform: uppercase; font-weight: bold; }

        /* ITEMS BUFFER */
        .items-buffer-ui { background: #222; padding: 10px; border-radius: 6px; border: 1px solid #333; }
        .buffer-row { display: flex; gap: 5px; margin-bottom: 10px; align-items: flex-end; }
        .buffer-list { border-top: 1px solid #333; padding-top: 10px; max-height: 150px; overflow-y: auto; }
        .buffer-item { display: flex; justify-content: space-between; align-items: center; background: #2a2a2e; margin-bottom: 5px; padding: 5px 10px; border-radius: 4px; font-size: 12px; }

        .toast { position: fixed; bottom: 20px; right: 20px; background: var(--success); color: #000; padding: 10px 20px; border-radius: 4px; font-weight: bold; transform: translateY(100px); transition: 0.3s; z-index: 3000; }
        .toast.show { transform: translateY(0); }
    </style>
</head>
<body>

    <header>
        <h1>Five Magics <span>Manager</span></h1>
        <div style="display: flex; gap: 10px; align-items: center;">
            <button class="btn btn-secondary btn-sm" onclick="app.io.exportCSV()">‚¨á Exportar CSV</button>
            <button class="btn btn-secondary btn-sm" onclick="app.io.exportJSON()">‚¨á Exportar JSON</button>
            <label class="btn btn-secondary btn-sm">
                ‚¨Ü Importar
                <input type="file" id="fileInput" accept=".json,.csv,.txt" style="display: none;" onchange="app.io.importFile(this)">
            </label>
            <button class="btn btn-danger btn-sm" onclick="app.data.clearAll()">üóëÔ∏è Vaciar Todo</button>
        </div>
    </header>

    <div class="stats-container" id="statsPanel"></div>

    <div class="controls-bar">
        <button class="btn btn-primary" onclick="app.ui.openModal()">+ Nuevo Pedido</button>
        <button class="btn btn-secondary" onclick="app.data.dedupe()">Limpiar Duplicados</button>
        
        <div class="filters-group">
            <input type="text" id="filterSearch" placeholder="Buscar cliente..." onkeyup="app.render()">
            <select id="filterStatus" onchange="app.render()">
                <option value="">Estado: Todos</option>
                <option value="Ingresado">Ingresado</option>
                <option value="En Producci√≥n">En Producci√≥n</option>
                <option value="Despachado">Despachado</option>
                <option value="Entregado">Entregado</option>
            </select>
            <select id="filterChannel" onchange="app.render()">
                <option value="">Canal: Todos</option>
                <option value="Instagram">Instagram</option>
                <option value="WhatsApp">WhatsApp</option>
                <option value="Web">Web</option>
            </select>
        </div>
    </div>

    <div class="table-container">
        <table id="ordersTable">
            <thead>
                <tr>
                    <th onclick="app.sort('fecha_pedido')">Fecha</th>
                    <th>ID Orden</th>
                    <th onclick="app.sort('nombre_apellido')">Cliente</th>
                    <th>Resumen Items</th>
                    <th>Talle</th>
                    <th>Cant</th>
                    <th onclick="app.sort('precio_venta')">Venta</th>
                    <th onclick="app.sort('costo_remera')">Costo Mercader√≠a</th>
                    <th onclick="app.sort('costo_envio')">Gasto Env√≠o</th>
                    <th onclick="app.sort('ganancia_neta')">Ganancia</th>
                    <th>Env√≠o</th>
                    <th>Tracking</th>
                    <th>Estado</th>
                    <th>Canal</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <div class="modal-overlay" id="orderModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle" style="margin:0; font-size:18px; color:var(--text-main);">Nuevo Pedido</h2>
                <button class="btn btn-secondary btn-sm" onclick="app.ui.closeModal()">‚úï</button>
            </div>
            
            <div class="modal-body">
                <form id="orderForm" onsubmit="event.preventDefault(); app.data.save();">
                    <input type="hidden" id="id_pedido">
                    
                    <div class="form-grid">
                        <div class="form-section">üë§ Datos del Cliente</div>
                        
                        <div class="form-group">
                            <label>Nombre y Apellido *</label>
                            <input type="text" id="nombre_apellido" required>
                        </div>
                        <div class="form-group">
                            <label>Canal de Venta</label>
                            <select id="red_contactado">
                                <option value="Instagram">Instagram</option>
                                <option value="WhatsApp">WhatsApp</option>
                                <option value="Web">Web</option>
                                <option value="Otro">Otro</option>
                            </select>
                        </div>
                        <div class="form-group"><label>Tel√©fono</label><input type="text" id="telefono"></div>
                        <div class="form-group"><label>Link Perfil/Chat</label><input type="text" id="links"></div>
                        <div class="form-group full-span"><label>Direcci√≥n</label><input type="text" id="direccion"></div>
                        <div class="form-group"><label>Localidad</label><input type="text" id="localidad"></div>
                        <div class="form-group"><label>CP</label><input type="text" id="cp"></div>

                        <div class="form-section">üëï Prendas (Agregador)</div>
                        <div class="full-span items-buffer-ui">
                            <div class="buffer-row">
                                <div style="flex:2"><input type="text" id="bf_diseno" placeholder="Dise√±o"></div>
                                <div style="flex:1"><input type="text" id="bf_talle" placeholder="Talle"></div>
                                <div style="flex:1"><input type="text" id="bf_color" placeholder="Color"></div>
                                <div style="flex:0.5"><input type="number" id="bf_cant" value="1" placeholder="#"></div>
                                <div style="flex:1"><input type="number" id="bf_precio" placeholder="$ Unit"></div>
                                <button type="button" class="btn btn-primary" onclick="app.ui.addBuffer()">+</button>
                            </div>
                            <div id="bufferList" class="buffer-list"></div>
                        </div>

                        <div class="form-section">üí∞ Econom√≠a & Env√≠o</div>
                        
                        <div class="form-group"><label>Fecha Pedido *</label><input type="date" id="fecha_pedido" required></div>
                        <div class="form-group"><label>Nro Orden DF</label><input type="text" id="nro_orden_df"></div>
                        
                        <div class="form-group"><label>Total Venta ($)</label><input type="number" id="precio_venta" step="0.01"></div>
                        <div class="form-group"><label>Costo Mercader√≠a ($)</label><input type="number" id="costo_remera" step="0.01"></div>
                        <div class="form-group"><label>Costo Env√≠o ($)</label><input type="number" id="costo_envio" step="0.01"></div>
                        <div class="form-group"><label>Gasto Publicidad ($)</label><input type="number" id="gastos_publicidad" step="0.01"></div>

                        <div class="form-group"><label>Estado</label>
                            <select id="estado_entrega_actual">
                                <option value="Ingresado">Ingresado</option>
                                <option value="En Producci√≥n">En Producci√≥n</option>
                                <option value="Listo para despachar">Listo para despachar</option>
                                <option value="Despachado">Despachado</option>
                                <option value="En tr√°nsito">En tr√°nsito</option>
                                <option value="En distribuci√≥n">En distribuci√≥n</option>
                                <option value="En sucursal">En sucursal</option>
                                <option value="Llega hoy">Llega hoy</option>
                                <option value="Entregado">Entregado</option>
                                <option value="No entregado">No entregado</option>
                                <option value="Devuelto">Devuelto</option>
                                <option value="Cancelado">Cancelado</option>
                            </select>
                        </div>
                        <div class="form-group"><label>Empresa Env√≠o</label><input type="text" id="empresa_envio"></div>
                        
                        <div class="form-group full-span">
                            <label style="color:var(--accent-cyan);">N√öMERO DE SEGUIMIENTO (TRACKING)</label>
                            <input type="text" id="nro_envio" style="border-color:var(--accent-cyan);">
                        </div>

                        <div class="form-group full-span"><label>Notas / Rese√±a</label><textarea id="resena" rows="2"></textarea></div>
                    </div>

                    <div style="margin-top: 20px; text-align: right; border-top: 1px solid #333; padding-top: 15px;">
                        <button type="submit" class="btn btn-primary" style="padding:12px 24px; font-size:13px;">üíæ GUARDAR PEDIDO</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
            // Recordatorio de exportar JSON al cerrar la web
            let exportReminderShown = false;
            window.addEventListener('beforeunload', function(e) {
                if (!exportReminderShown) {
                    e.preventDefault();
                    // Chrome requiere returnValue para mostrar el di√°logo
                    e.returnValue = '';
                    setTimeout(()=>{
                        if (!document.getElementById('export-reminder-modal')) {
                            const modal = document.createElement('div');
                            modal.id = 'export-reminder-modal';
                            modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.85);z-index:9999;display:flex;align-items:center;justify-content:center;';
                            modal.innerHTML = `
                                <div style="background:#222;padding:30px 40px;border-radius:10px;box-shadow:0 0 30px #000;max-width:90vw;text-align:center;">
                                    <h2 style='color:var(--accent-violet);margin-bottom:20px;'>¬øExportaste el backup de hoy?</h2>
                                    <p style='color:#eee;margin-bottom:25px;'>Te recomendamos exportar el archivo JSON antes de cerrar la web para no perder datos.<br>¬øQu√© deseas hacer?</p>
                                    <button id='btn-exportar-ahora' style='margin:8px 20px 0 0;padding:10px 18px;font-size:15px;background:var(--accent-cyan);color:#222;border:none;border-radius:5px;cursor:pointer;'>Exportar ahora</button>
                                    <button id='btn-ya-exporte' style='margin:8px 0 0 0;padding:10px 18px;font-size:15px;background:var(--success);color:#222;border:none;border-radius:5px;cursor:pointer;'>Ya export√©</button>
                                </div>
                            `;
                            document.body.appendChild(modal);
                            document.getElementById('btn-exportar-ahora').onclick = function() {
                                app.io.exportJSON(true); // true = forzar descarga con fecha
                                document.body.removeChild(modal);
                                exportReminderShown = true;
                                window.close();
                            };
                            document.getElementById('btn-ya-exporte').onclick = function() {
                                document.body.removeChild(modal);
                                exportReminderShown = true;
                                window.close();
                            };
                        }
                    }, 100);
                }
            });
        const app = {
            state: { orders: [], sortCol: 'nro_orden_df', sortAsc: false },
            ui: { _buffer: [] },

            init: function() {
                const s = localStorage.getItem('fmd_pedidos');
                if(s) try { this.state.orders = JSON.parse(s); } catch(e){}
                this.render();
            },

            data: {
                save: function() {
                    const id = document.getElementById('id_pedido').value;
                    const items = app.ui._buffer.length ? app.ui._buffer : [];
                    
                    // C√°lculo de totales
                    let tVenta = parseFloat(document.getElementById('precio_venta').value)||0;
                    let tCosto = parseFloat(document.getElementById('costo_remera').value)||0;
                    
                    // Si hay items en buffer y los inputs de total est√°n vac√≠os o default, sumamos items
                    if(items.length > 0 && tVenta === 0) {
                        tVenta = 0; tCosto = 0;
                        items.forEach(i => {
                            tVenta += (parseFloat(i.precio_venta)||0) * (parseInt(i.cantidad)||1);
                            tCosto += (parseFloat(i.costo_remera)||0) * (parseInt(i.cantidad)||1);
                        });
                    }

                    const cEnvio = parseFloat(document.getElementById('costo_envio').value)||0;
                    const cAds = parseFloat(document.getElementById('gastos_publicidad').value)||0;

                    // Si no hay items, creamos uno dummy para compatibilidad
                    if(items.length === 0) {
                        items.push({
                            dise√±o_frente: 'Varios / Manual', talle: '-', cantidad: 1, 
                            precio_venta: tVenta, costo_remera: tCosto
                        });
                    }

                    const order = {
                        id_pedido: id || 'ord_' + Date.now(),
                        fecha_pedido: document.getElementById('fecha_pedido').value,
                        nro_orden_df: document.getElementById('nro_orden_df').value,
                        nombre_apellido: document.getElementById('nombre_apellido').value,
                        red_contactado: document.getElementById('red_contactado').value,
                        telefono: document.getElementById('telefono').value,
                        links: document.getElementById('links').value,
                        direccion: document.getElementById('direccion').value,
                        localidad: document.getElementById('localidad').value,
                        cp: document.getElementById('cp').value,
                        
                        items: items,
                        cantidad: items.reduce((a,b)=>a+(parseInt(b.cantidad)||0),0),
                        
                        // Campos legacy
                        dise√±o_frente: items[0]?.dise√±o_frente || '',
                        talle: items[0]?.talle || '',
                        color_remera: items[0]?.color_remera || '',

                        estado_entrega_actual: document.getElementById('estado_entrega_actual').value,
                        empresa_envio: document.getElementById('empresa_envio').value,
                        nro_envio: document.getElementById('nro_envio').value, // TRACKING
                        
                        precio_venta: tVenta,
                        costo_remera: tCosto,
                        costo_envio: cEnvio,
                        gastos_publicidad: cAds,
                        ganancia_neta: tVenta - tCosto - cEnvio - cAds,
                        resena: document.getElementById('resena').value
                    };

                    if(id) {
                        const idx = app.state.orders.findIndex(o => o.id_pedido === id);
                        if(idx !== -1) app.state.orders[idx] = order;
                    } else {
                        app.state.orders.push(order);
                    }

                    app.persist();
                    app.ui.closeModal();
                    app.ui.toast("Guardado correctamente");
                },
                
                delete: function(id) {
                    if(confirm("¬øBorrar este pedido?")) {
                        app.state.orders = app.state.orders.filter(o => o.id_pedido !== id);
                        app.persist();
                        app.ui.toast("Eliminado");
                    }
                },
                
                clearAll: function() {
                    if(confirm("‚ö† ATENCI√ìN: ESTO BORRA TODO. ¬øCONFIRMAR?")) {
                        app.state.orders = [];
                        app.persist();
                        app.ui.toast("Base de datos vaciada");
                    }
                },

                dedupe: function() {
                    const seen = new Set();
                    const clean = [];
                    app.state.orders.forEach(o => {
                        // Clave: OrdenDF √≥ Cliente+Fecha+Total (para evitar borrar pedidos del mismo cliente en misma fecha pero distintos montos)
                        const key = o.nro_orden_df ? 'df_'+o.nro_orden_df : 'cl_'+o.nombre_apellido+'_'+o.fecha_pedido+'_'+o.precio_venta;
                        if(!seen.has(key)) { seen.add(key); clean.push(o); }
                    });
                    const diff = app.state.orders.length - clean.length;
                    app.state.orders = clean;
                    app.persist();
                    app.ui.toast(`Se eliminaron ${diff} duplicados`);
                }
            },

            ui: {
                openModal: function(id = null) {
                    const m = document.getElementById('orderModal');
                    document.getElementById('orderForm').reset();
                    document.getElementById('id_pedido').value = '';
                    document.getElementById('bufferList').innerHTML = '';
                    this._buffer = [];
                    document.getElementById('modalTitle').innerText = id ? "Editar Pedido" : "Nuevo Pedido";

                    if(id) {
                        const o = app.state.orders.find(x => x.id_pedido === id);
                        if(o) {
                            document.getElementById('id_pedido').value = o.id_pedido;
                            const set = (k, v) => { try { document.getElementById(k).value = v || ''; } catch(e){} };
                            
                            set('nombre_apellido', o.nombre_apellido);
                            set('red_contactado', o.red_contactado);
                            set('telefono', o.telefono);
                            set('links', o.links);
                            set('direccion', o.direccion);
                            set('localidad', o.localidad);
                            set('cp', o.cp);
                            
                            set('fecha_pedido', o.fecha_pedido);
                            set('nro_orden_df', o.nro_orden_df);
                            set('precio_venta', o.precio_venta);
                            set('costo_remera', o.costo_remera);
                            set('costo_envio', o.costo_envio);
                            set('gastos_publicidad', o.gastos_publicidad);
                            
                            set('estado_entrega_actual', o.estado_entrega_actual);
                            set('empresa_envio', o.empresa_envio);
                            set('nro_envio', o.nro_envio); // TRACKING
                            set('resena', o.resena);

                            if(o.items && Array.isArray(o.items)) {
                                this._buffer = JSON.parse(JSON.stringify(o.items));
                                this.renderBuffer();
                            }
                        }
                    } else {
                        document.getElementById('fecha_pedido').valueAsDate = new Date();
                    }
                    m.classList.add('open');
                },
                closeModal: function() { document.getElementById('orderModal').classList.remove('open'); },
                
                addBuffer: function() {
                    const d = document.getElementById('bf_diseno').value;
                    if(!d) return;
                    this._buffer.push({
                        dise√±o_frente: d,
                        talle: document.getElementById('bf_talle').value,
                        color_remera: document.getElementById('bf_color').value,
                        cantidad: document.getElementById('bf_cant').value,
                        precio_venta: document.getElementById('bf_precio').value,
                        costo_remera: 0
                    });
                    document.getElementById('bf_diseno').value = '';
                    this.renderBuffer();
                },
                renderBuffer: function() {
                    const c = document.getElementById('bufferList');
                    let sum = 0;
                    c.innerHTML = this._buffer.map((i,x) => {
                        sum += (parseFloat(i.precio_venta)||0)*(parseInt(i.cantidad)||1);
                        return `
                        <div class="buffer-item">
                            <span><strong>${(i.dise√±o_frente||'').toUpperCase()}</strong> (${i.talle}) x${i.cantidad}</span>
                            <span style="color:var(--danger); cursor:pointer;" onclick="app.ui.remBuffer(${x})">X</span>
                        </div>`;
                    }).join('');
                    if(sum > 0) document.getElementById('precio_venta').value = sum;
                },
                setManualAds: function(v) {
                    const n = parseFloat(v)||0;
                    localStorage.setItem('fmd_manual_ads', n);
                    app.render();
                },
                remBuffer: function(idx) { this._buffer.splice(idx, 1); this.renderBuffer(); },
                toast: function(msg) {
                    const t = document.getElementById('toast');
                    t.innerText = msg; t.classList.add('show');
                    setTimeout(()=>t.classList.remove('show'), 3000);
                }
            },

            io: {
                importFile: function(input) {
                    const f = input.files[0];
                    if(!f) return;
                    const r = new FileReader();
                    r.onload = (e) => {
                        try {
                            const json = JSON.parse(e.target.result);
                            const list = Array.isArray(json) ? json : (json.orders || []);
                            let added = 0;
                            // Merge
                            const ids = new Set(app.state.orders.map(o=>o.id_pedido));
                            list.forEach(p => {
                                if(!p.id_pedido) p.id_pedido = 'imp_'+Math.random().toString(36).substr(2);
                                // MAP TRACKING SMARTLY
                                if(!p.nro_envio && p.tracking) p.nro_envio = p.tracking;
                                
                                if(!ids.has(p.id_pedido)) {
                                    app.state.orders.push(p);
                                    added++;
                                }
                            });
                            app.persist();
                            app.ui.toast(`Importados ${added} pedidos`);
                        } catch(err) { alert("Error: Archivo inv√°lido"); }
                    };
                    r.readAsText(f);
                    input.value = '';
                },
                exportJSON: function(forceFecha) {
                    const manualAds = parseFloat(localStorage.getItem('fmd_manual_ads'))||0;
                    const payload = { orders: app.state.orders, meta: { manualAds: manualAds, exportedAt: (new Date()).toISOString() } };
                    const b = new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
                    let fileName = 'fmd_backup.json';
                    if (forceFecha) {
                        const d = new Date();
                        const yyyy = d.getFullYear();
                        const mm = String(d.getMonth()+1).padStart(2,'0');
                        const dd = String(d.getDate()).padStart(2,'0');
                        fileName = `fmd_backup_${yyyy}-${mm}-${dd}.json`;
                    }
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(b); a.download = fileName; a.click();
                },
                exportCSV: function() {
                    let csv = "Fecha,Orden,Cliente,Tracking,Venta,CostoMercaderia,CostoEnvio,Publicidad,Ganancia,Estado\n";
                    app.state.orders.forEach(o => {
                        csv += `${o.fecha_pedido},${o.nro_orden_df},"${o.nombre_apellido}","${o.nro_envio||''}",${o.precio_venta||0},${o.costo_remera||0},${o.costo_envio||0},${o.gastos_publicidad||0},${o.ganancia_neta||0},${o.estado_entrega_actual}\n`;
                    });
                    const b = new Blob([csv],{type:'text/csv'});
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(b); a.download = 'fmd_export.csv'; a.click();
                }
            },

            persist: function() {
                localStorage.setItem('fmd_pedidos', JSON.stringify(this.state.orders));
                this.render();
            },

            render: function() {
                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = '';
                const search = document.getElementById('filterSearch').value.toLowerCase();
                const st = document.getElementById('filterStatus').value;
                const ch = document.getElementById('filterChannel').value;

                let stats = { cnt:0, sale:0, prof:0, ads:0, env:0, cost:0 };
                const manualAds = parseFloat(localStorage.getItem('fmd_manual_ads'))||0;

                // Sort
                const s = this.state.sortCol;
                const asc = this.state.sortAsc;
                this.state.orders.sort((a,b) => {
                                let va=a[s], vb=b[s];
                                // Si es n√∫mero de orden, comparar como n√∫mero si es posible
                                if(s==='nro_orden_df') {
                                    va = parseInt(va)||0;
                                    vb = parseInt(vb)||0;
                                } else if(['precio_venta','ganancia_neta','costo_envio','costo_remera'].includes(s)) {
                                    va=parseFloat(va)||0; vb=parseFloat(vb)||0;
                                }
                    if(va<vb) return asc?-1:1; if(va>vb) return asc?1:-1; return 0;
                });

                this.state.orders.forEach(o => {
                    const txt = (o.nombre_apellido + o.nro_orden_df + (o.nro_envio||'')).toLowerCase();
                    if(search && !txt.includes(search)) return;
                    if(st && o.estado_entrega_actual !== st) return;
                    if(ch && o.red_contactado !== ch) return;

                    stats.cnt++;
                    stats.sale += parseFloat(o.precio_venta)||0;
                    stats.prof += parseFloat(o.ganancia_neta)||0;
                    stats.ads += parseFloat(o.gastos_publicidad)||0;
                    stats.env += parseFloat(o.costo_envio)||0;
                    stats.cost += parseFloat(o.costo_remera)||0;

                    let itemsHtml = o.items && o.items.length ? 
                        o.items.map(i=>`<div>${(i.dise√±o_frente||'').toUpperCase()} (${i.talle})</div>`).join('') :
                        `<div>${(o.dise√±o_frente||'').toUpperCase()}</div>`;

                    const tr = document.createElement('tr');
                    if (o.estado_entrega_actual === 'Entregado') {
                        tr.classList.add('row-entregado');
                    }
                    tr.innerHTML = `
                        <td style="color:var(--accent-violet)">${o.fecha_pedido}</td>
                        <td><span class="order-id">#${o.nro_orden_df||''}</span></td>
                        <td>
                            <strong>${o.nombre_apellido}</strong>
                            <div style="font-size:10px; color:#aaa; line-height:1;">${o.localidad ? o.localidad : ''}</div>
                        </td>
                        <td style="font-size:11px; color:#aaa">${itemsHtml}</td>
                        <td>${o.talle||'-'}</td>
                        <td>${o.cantidad||1}</td>
                            <td class="money">$${(parseFloat(o.precio_venta)||0).toLocaleString()}</td>
                            <td class="money">$${(parseFloat(o.costo_remera)||0).toLocaleString()}</td>
                            <td class="money">$${(parseFloat(o.costo_envio)||0).toLocaleString()}</td>
                            <td class="money ${o.ganancia_neta>=0?'pos':'neg'}">$${(parseFloat(o.ganancia_neta)||0).toLocaleString()}</td>
                            <td style="font-size:11px">${o.empresa_envio||'-'}</td>
                        <td><span class="tracking-cell">${o.nro_envio||'-'}</span></td>
                        <td>${o.estado_entrega_actual}</td>
                        <td>${o.red_contactado||'-'}</td>
                        <td>
                            <button class="btn btn-secondary btn-sm" onclick="app.ui.openModal('${o.id_pedido}')">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-sm" onclick="app.data.delete('${o.id_pedido}')">üóëÔ∏è</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

                // helper formato y porcentajes
                const fmtMoney = v => '$' + (v||0).toLocaleString();
                const pctOfSales = v => stats.sale > 0 ? ((v/stats.sale*100).toFixed(1) + '%') : '-';

                const adsTotal = stats.ads + manualAds; // per-orders + manual override
                const displayProfit = stats.prof - manualAds; // subtract manual ads from displayed profit

                // preserve focus/selection if user is typing in manualAdsInput
                const prevActive = document.activeElement;
                let manualFocused = false, selStart=0, selEnd=0;
                try {
                    if(prevActive && prevActive.id === 'manualAdsInput') { manualFocused = true; selStart = prevActive.selectionStart; selEnd = prevActive.selectionEnd; }
                } catch(e) {}

                document.getElementById('statsPanel').innerHTML = `
                    <div class="stat-card"><div class="stat-val">${stats.cnt}</div><div class="stat-lbl">Pedidos</div></div>
                    <div class="stat-card"><div class="stat-val">${fmtMoney(stats.sale)}</div><div class="stat-lbl">Ventas <span style="color:#aaa">¬∑ ${pctOfSales(stats.sale)}</span></div></div>
                    <div class="stat-card">
                        <div class="stat-val" style="color:var(--danger)">${fmtMoney(adsTotal)}</div>
                        <div class="stat-lbl">Publicidad <span style="color:#aaa">¬∑ ${pctOfSales(adsTotal)}</span></div>
                        <div style="margin-top:6px;"><input id="manualAdsInput" type="number" step="0.01" min="0" value="${manualAds}" style="width:110px;background:#2a2a2e;border:1px solid #333;color:#fff;padding:6px;border-radius:4px;font-size:12px;"></div>
                    </div>
                    <div class="stat-card"><div class="stat-val">${fmtMoney(stats.cost)}</div><div class="stat-lbl">Costo Mercader√≠a <span style="color:#aaa">¬∑ ${pctOfSales(stats.cost)}</span></div></div>
                    <div class="stat-card"><div class="stat-val">${fmtMoney(stats.env)}</div><div class="stat-lbl">Env√≠os <span style="color:#aaa">¬∑ ${pctOfSales(stats.env)}</span></div></div>
                    <div class="stat-card" title="F√≥rmula: Ventas - Costo Mercader√≠a - Env√≠os - Publicidad"><div class="stat-val" style="color:var(--success)">${fmtMoney(displayProfit)}</div><div class="stat-lbl">Ganancia Neta <span style="color:#aaa">¬∑ ${pctOfSales(displayProfit)}</span></div></div>
                `;

                // attach input handler and restore caret if needed
                const mInput = document.getElementById('manualAdsInput');
                if(mInput) {
                    mInput.value = manualAds;
                    mInput.addEventListener('input', function(){ app.ui.setManualAds(this.value); });
                    if(manualFocused) {
                        try { mInput.focus(); mInput.setSelectionRange(selStart, selEnd); } catch(e){}
                    }
                }
            },
            sort: function(col) {
                if(this.state.sortCol === col) this.state.sortAsc = !this.state.sortAsc;
                else { this.state.sortCol = col; this.state.sortAsc = true; }
                this.render();
            }
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // GA4 WHATSAPP CLICK TRACKING (Global Listener)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        document.addEventListener("click", function (e) {
          const a = e.target.closest("a");
          if (!a) return;

          const href = (a.getAttribute("href") || "").toLowerCase();
          const isWhatsApp =
            href.includes("wa.me/") ||
            href.includes("api.whatsapp.com/") ||
            href.includes("web.whatsapp.com/") ||
            href.startsWith("whatsapp:");

          if (!isWhatsApp) return;

          if (typeof gtag === "function") {
            gtag("event", "whatsapp_click", {
              link_url: a.href || href,
              link_text: (a.innerText || "").trim().slice(0, 80),
              page_path: location.pathname,
            });
          }
        }, true);

        // Track window.open WhatsApp usage
        (function () {
          const originalOpen = window.open;
          window.open = function (url, ...rest) {
            try {
              const u = String(url || "").toLowerCase();
              const isWhatsApp =
                u.includes("wa.me/") ||
                u.includes("api.whatsapp.com/") ||
                u.includes("web.whatsapp.com/");

              if (isWhatsApp && typeof gtag === "function") {
                gtag("event", "whatsapp_click", {
                  link_url: String(url),
                  page_path: location.pathname,
                  trigger: "window.open",
                });
              }
            } catch (_) {}
            return originalOpen.call(window, url, ...rest);
          };
        })();

        window.onload = () => app.init();
    </script>
</body>
</html>